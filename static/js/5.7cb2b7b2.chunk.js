(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{58:function(e,t,n){"use strict";n.r(t),n.d(t,"readingTime",function(){return u}),n.d(t,"default",function(){return b}),n.d(t,"tableOfContents",function(){return m}),n.d(t,"frontMatter",function(){return k});var a=n(16),s=(n(0),n(22)),o=n(59),i=n.n(o),r=n(60),l=n.n(r),c=n(61),p=n.n(c),u={text:"16 min read",minutes:15.145,time:908699.9999999999,words:3029},d={},h="wrapper";function b(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(s.b)(h,Object.assign({},d,n,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,"In the ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"../../2019-08-19/Data-Engineering-Pt-1"}),"last post")," we discussed a simple requirement to store tweets and make them available to other applications. It quickly became clear that it wasn\u2019t as simple as it looked - in fact, it was so complicated that it actually called for an entire platform to be built, replete with a full data plane and separate control plane."),Object(s.b)("p",null,"Mocking up the platform side of things is the subject of this post, in which we\u2019ll discuss getting a dev environment set up. Once you land in an organisation, the first thing you often want to do is replicate their production environment as closely as possible, ideally locally on your own machine. This allows you to test your application in an environment that mirrors the one it will ultimately run in."),Object(s.b)("h3",{id:"but-my-code-is-already-unit-tested"},"\u201cBut my code is already unit tested!\u201d"),Object(s.b)("figure",{className:i.a.figure},Object(s.b)("img",{src:p.a,className:i.a.image,alt:"Cool guy coding."}),Object(s.b)("figcaption",null,"No number of unit tests will make you this guy.")),Object(s.b)("p",null,"This is a common objection to this approach when you present it to traditional software engineers. But if those tests are like most I\u2019ve seen, I suspect that they might say something very deep and subtle like ",Object(s.b)("inlineCode",{parentName:"p"},"assert MyClass==MyClass"),". This is roughly equivalent to the conversation at every bad first date you\u2019ve ever been on. ",Object(s.b)("em",{parentName:"p"},"Your tests will agree with a set of statements which only a psychopathic piece of code would fail to agree with, and which tell you nothing about the inner workings of the subject under examination; much less its performance in your particular environment, how it will get along with the rest of the apps if invited to a party, whether it will try to monopolise your limited resources, or knows how to clean up after itself.")),Object(s.b)("p",null,"Sorry, we were talking about software weren\u2019t we\u2026"),Object(s.b)("p",null,"Even if you\u2019ve gone to the trouble of finding a proper test framework and using some sample data (because this is about data science, remember?) ",Object(s.b)("strong",{parentName:"p"},"the scale or velocity of that data may be completely different in the real world - this is often the problem you are trying to solve.")," So unit testing doesn\u2019t really cut the mustard, ",Object(s.b)("em",{parentName:"p"},"and actually the local testing approach we demonstrate here isn\u2019t very thorough either, but it doesn\u2019t require you to go and buy resources on GCP or AWS, so that\u2019s a plus, and you can always do that later.")),Object(s.b)("div",{className:i.a.sidebarcontainer},Object(s.b)("span",{className:i.a.sidebar},Object(s.b)("h3",{id:"whats-in-the-box-about-the-images-were-using"},"What\u2019s in the box? About the images we\u2019re using."),Object(s.b)("p",null,"This is a mock platform, so it is going to be missing things. While you\u2019re welcome to talk to me on Twitter about all the things it is missing, I expect that there will be a vast number. What we are including however, is;"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"gcr.io/etcd-development/etcd:v3.3.13"),Object(s.b)("li",{parentName:"ul"},"landoop/fast-data-dev"),Object(s.b)("li",{parentName:"ul"},"fluent/fluentd:v1.3-debian-1")),Object(s.b)("p",null,"Oh? You went and ran ",Object(s.b)("inlineCode",{parentName:"p"},"Docker pull")," didn\u2019t you? Sorry,",Object(s.b)("strong",{parentName:"p"}," Minikube runs in a VM with a wholly separate filesystem.")," You may want to delete those if you\u2019re short of disk space. Minikube creates and deletes VMs all the time, so add the above images to a cache using ",Object(s.b)("inlineCode",{parentName:"p"},"minikube cache add ${IMAGE}")," to avoid re-downloading frequently."),Object(s.b)("p",null,"The etcd and fluentd images are provided by the organisations developing both tools. The ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://github.com/Landoop/fast-data-dev"}),"Landoop Kafka image")," is one that I see out in the industry semi-regularly, it contains a full Kafka setup which includes Zookeeper and a Schema Registry, alongside some GUI tools to inspect your cluster and make sure it is giving the expected results. Feel free to work something up from the official Confluent images or similar if that\u2019s more your speed, but be prepared to spend a great deal of time kludging around with unwieldly arguments with Kafka\u2019s CLI tools ",Object(s.b)("em",{parentName:"p"},"(I\u2019m generally a CLI fan, but only where they have been designed for humans, or indeed designed at all)"),".")),Object(s.b)("h2",{id:"pre-requisites"},"Pre-requisites"),Object(s.b)("p",null,"I will assume you have Docker installed and are reasonably proficient at using it. There are plenty of tutorials to help with that, so I\u2019ll suggest a Google search if you hit issues. You will also need to install ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://kubernetes.io/docs/setup/learning-environment/minikube/"}),"Minikube")," and ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/"}),"Kubectl"),", which we\u2019ll use to mock Kubernetes (but only gently, so as not to hurt its feelings). ",Object(s.b)("strong",{parentName:"p"},"I strongly advise enabling autocompletion")," for Kubectl (and most CLI\u2019s generally), and future you will be greatful to be one of the few engineers without RSI if you do so."),Object(s.b)("p",null,"I\u2019m running everything on Linux, and you can look up instructions for Windows. ",Object(s.b)("em",{parentName:"p"},"(Personally, my advice is \u201cperhaps consider a different career path, I hear accounting is nice and has something to do with numbers, so it must be just like AI - right?\u201d Ironically, I\u2019m relying on readers not taking this advice to keep my potential readership relatively high - because Windows is still quite dominant.)")),Object(s.b)("p",null,"You\u2019ll also need to ensure you have git installed - presumably you\u2019re familiar with it as well, otherwise its back to Coursera with you. Or you can enjoy the ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://git-man-page-generator.lokaltog.net/"}),"documentation")," (that link points to a parody, but I can\u2019t tell the difference)."),Object(s.b)("h2",{id:"getting-started---minikube"},"Getting started - Minikube"),Object(s.b)("p",null,"If you\u2019ve recovered from reading the parody Git manpages, ",Object(s.b)("strong",{parentName:"p"},"you can clone the ",Object(s.b)("a",Object.assign({parentName:"strong"},{href:"https://github.com/Miles-Garnsey/DataEngineeringPt2"}),"repo")," if you\u2019re following along.")),Object(s.b)("p",null,"Bring minikube up using ",Object(s.b)("inlineCode",{parentName:"p"},"minikube start --memory=8192 --cpus=2 --extra-config=apiserver.enable-admission-plugins=PodSecurityPolicy"),", and wait for\u2026 a long time\u2026 (Note that there is advice floating about online suggesting you can use something like ",Object(s.b)("inlineCode",{parentName:"p"},"--extra-config=apiserver.GenericServerRunOptions.AdmissionControl=....")," - this was deprecated, and leads to fierce and incomprehensible errors, as does the attempted use of things like PersistentVolumeLabel. Meanwhile, various admission plugins are enabled by default, so the only one we need to focus on is ",Object(s.b)("inlineCode",{parentName:"p"},"PodSecurityPolicy"),".)"),Object(s.b)("span",{style:{color:"red"}}," (**EDIT: September 19:** starting this week I've had some trouble with this approach. Haven't had time to research properly; initially I suspected that minikube may have updated something to require `--extra-config=apiserver.authorization-mode=RBAC`. But having done a bit more reading (per this [link](https://github.com/kubernetes/minikube/issues/3818)), I think I neglected to configure some security policies authorizing the core services - this naturally prevents the cluster from coming up. I've updated the github repo for this post to include the relevant policies in `psp.yaml`, which needs to be copied to `~/.minikube/files/etc/kubernetes/addons/psp.yaml`, and I've updated `k8s-configure.sh` to include this step. I may write an additional post exploring psp.yaml and providing more detail on how it works, it gave me some insight to fix up my podsecuritypolicy settings which I've improved in `devSecurity.yaml`, as I don't believe these were being applied as intended. "),Object(s.b)("p",null,"Once it is up, you should have a mock K8s cluster running in a VM, which you can describe using your kubectl commands such as ",Object(s.b)("inlineCode",{parentName:"p"},"kubectl describe-cluster"),". If that all works, we\u2019re good to go.")),Object(s.b)("h2",{id:"kubernetes-concepts-and-setup"},"Kubernetes Concepts and setup"),Object(s.b)("p",null,"Kubernetes has a few entities you\u2019ll need to familiar with, notably - nodes, pods, services, controllers and containers. The documentation on the main website is somewhat unsatisfactory when it comes to describing the design succinctly, and I advise you to consult the ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/architecture/architecture.md#the-kubernetes-node"}),"architecture doc")," for detail. ",Object(s.b)("strong",{parentName:"p"},"Summarising, containers are just Docker containers (at least for our purposes), they run in pods on nodes, which are hosts, and are exposed by services which do network related stuff like load balancing, DNS (including discovery etc.), controllers do deployment and scaling. The pod is kind of the interesting part of Kubernetes that differentiates it from Docker compose in many ways.")),Object(s.b)("span",{className:i.a.sidebar},Object(s.b)("h2",{id:"running-an-application-on-kubernetes"},"Running an application on Kubernetes"),Object(s.b)("p",null,"Kubernetes is so flexible that the number of configurables can become overwhelming, so it helps to have a checklist of considerations when you\u2019re crafting a deployment. ",Object(s.b)("strong",{parentName:"p"},"The basics you want to include are;")),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"A namespace"),Object(s.b)("li",{parentName:"ol"},"Memory and CPU limits"),Object(s.b)("li",{parentName:"ol"},"A container image"),Object(s.b)("li",{parentName:"ol"},"A service to handle load balancing"),Object(s.b)("li",{parentName:"ol"},"The number of replicas you\u2019ll require"),Object(s.b)("li",{parentName:"ol"},"(Optional, stateful applications only) Any volumes you\u2019ll need.")),Object(s.b)("p",null,Object(s.b)("em",{parentName:"p"},"N.B. - it should be noted that management love checklists for the same reason you like this one, they\u2019re just overwhelmed by more things; if you show your boss this checklist (and pass it off as your own) you will be able to run a meeting about Standardising Processes which will assure you of a tidy bonus while simultaneously earning you the undying contempt of your colleagues.")," ",Object(s.b)("strong",{parentName:"p"},"Good luck!"))),Object(s.b)("h3",{id:"kubernetes-pods"},"Kubernetes pods"),Object(s.b)("p",null,"Applications are deployed in pods, and each instance of the application container should be in its own pod. Pods do not handle replication. Instead, ",Object(s.b)("strong",{parentName:"p"},"think of them as a way of packaging the application for runtime/production"),". A production environment might mandate that all applications use a particular set of subsidiary apps/containers. Many of these might operate separately from the application itself, and this is called the ",Object(s.b)("strong",{parentName:"p"},"Sidecar Pattern"),". Some of the common things included are proxies that inspect network traffic before forwarding it to the container it was intended for, but there are a variety of use cases around application monitoring, networking, and other stuff that ops people care about and we aren\u2019t going to talk about."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Side note:")," pods are the thing that enable service mesh frameworks like ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://istio.io/"}),"Istio")," to fly. Istio (for example) installs a hook into K8s which modifies its default pod deployment behaviour and adds additional stuff. I may write a post about this later - one interesting implication is that we could consider taking REST traffic from our existing apps and proxying it to Kafka traffic to ameliorate the deficiencies REST suffers in persistence. There are also technologies such as Cilium, which bundles in additional security and might be worth evaluating for its Kafka interop. I only mention to sketch some of the flexibility available via Kubernetes."),Object(s.b)("h3",{id:"controllers-services-and-everything-else"},"Controllers, services\u2026 and everything else"),Object(s.b)("p",null,"Examples of controllers include ",Object(s.b)("strong",{parentName:"p"},Object(s.b)("a",Object.assign({parentName:"strong"},{href:"https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/"}),"replica sets")," (which is what we\u2019re using here), stateful sets, daemon sets, deployments")," and so on. These are just all different ways of getting some set of pods out onto some set of nodes in a cluster and keeping some number there under different conditions (the desired number being something that might change according to various scaling behaviours that we\u2019ll discuss much later). The documentation is sufficent to explain what these do, so I will not cover them in depth beyond mentioning their existence."),Object(s.b)("figure",{className:i.a.figure},Object(s.b)("img",{src:l.a,className:i.a.image,alt:"A very serious hacker."}),Object(s.b)("figcaption",null,"Crash override fails on ClusterIP.")),Object(s.b)("p",null,"As mentioned above; services do networking things, and in this series we are going to talk purely about ",Object(s.b)("inlineCode",{parentName:"p"},"ClusterIP")," services, which do not expose external IPs. If you have the privelege of having customers who might be interested in your app, you would be looking at load balancing, creating static public IP addresses, and other things that would require care and thought. You should not do any of these things unless you understand the security implications. ",Object(s.b)("strong",{parentName:"p"},"One more time. Do not do any of those things unless you understand the security implications.")),Object(s.b)("p",null,"If you want to add to the K8s API, you\u2019ll be pleased to hear that its entities are customisable. Customised resources that don\u2019t fit within the node/service/pod/container/controller paradigm are quite possible. This is an approach pursued by tools such as ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://www.kubeflow.org/"}),"Kubeflow")," which adds various machine learning tooling to K8s. This is quite useful, and worth keeping in mind if you plan to run some such service at scale."),Object(s.b)("h3",{id:"defining-kubernetes-entities"},"Defining Kubernetes entities"),Object(s.b)("div",{className:i.a.floatright},Object(s.b)("pre",null,Object(s.b)("code",Object.assign({parentName:"pre"},{className:"language-yaml","data-language":"yaml","data-highlighted-line-numbers":"",dangerouslySetInnerHTML:{__html:'<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka<span class="token punctuation">-</span>service\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app</span><span class="token punctuation">:</span> kafka\n    <span class="token key atrule">phase</span><span class="token punctuation">:</span> dev\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app</span><span class="token punctuation">:</span> kafka\n  <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9092</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka\n  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> schema<span class="token punctuation">-</span>registry\n  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3030</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka<span class="token punctuation">-</span>gui\n  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2181</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> zookeeper\n  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app</span><span class="token punctuation">:</span> kafka\n    <span class="token key atrule">phase</span><span class="token punctuation">:</span> dev\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>\n      <span class="token key atrule">app</span><span class="token punctuation">:</span> kafka\n  <span class="token key atrule">template</span><span class="token punctuation">:</span>\n    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n      <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n        <span class="token key atrule">app</span><span class="token punctuation">:</span> kafka\n    <span class="token key atrule">spec</span><span class="token punctuation">:</span>\n      <span class="token key atrule">containers</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> landoop/fast<span class="token punctuation">-</span>data<span class="token punctuation">-</span>dev\n        <span class="token key atrule">env</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CONNECT_HEAP\n          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1G"</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ADV_HOST\n          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"kafka-service.dev"</span>\n        <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n          <span class="token key atrule">limits</span><span class="token punctuation">:</span>\n            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"3000Mi"</span>\n            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>\n'}})))),Object(s.b)("p",null,"As you can see to your right (or above for those poor unfortunates trying to read this long thin piece of text on mobile), Kubernetes stuff is defined in YAML (which stands - in the great recursive acronym tradition pioneered by the likes of GNU - for YAML Ain\u2019t Markup)."),Object(s.b)("p",null,"Note that we\u2019ve created -"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"A ",Object(s.b)("inlineCode",{parentName:"li"},"kafka-service")," to handle ingress and egress to the Kafka cluster - it is a ",Object(s.b)("inlineCode",{parentName:"li"},"ClusterIP")," service, which means no access from outside the cluster, and we\u2019ve gone with an ",Object(s.b)("a",Object.assign({parentName:"li"},{href:"https://kubernetes.io/docs/concepts/services-networking/service/#with-selectors"}),"approach")," which uses selectors to route traffic to the pod via K8s DNS."),Object(s.b)("li",{parentName:"ol"},"A replica set with a single replica.")),Object(s.b)("p",null,"YAML is an irritating language to define things in; it is highly sensitive to spaces, has an awkward way of defining lists or arrays (basically a ",Object(s.b)("inlineCode",{parentName:"p"},"-")," followed by a space). Tabs are a no go in YAML and will break everything in hard to detect ways. If that\u2019s unclear and generally unpleasant to wrap your head around\u2026 then good, I\u2019m pleased you\u2019re getting a feel for the format."),Object(s.b)("p",null,"While YAML looks fine visually, and the intention is quite clear, it is painful to type and prone to errors. If something does go wrong, look for the use of tabs where spaces were intended, or the absence of spaces between ",Object(s.b)("inlineCode",{parentName:"p"},"-"),"s or ",Object(s.b)("inlineCode",{parentName:"p"},":"),"s. The only element that bears commenting on is the ",Object(s.b)("inlineCode",{parentName:"p"},"labels")," elements - these are just a way to subset your various K8s entities for subsequent selection and manipulation. You can do things like applying services to pods based on labels, which is what is happening above."),Object(s.b)("p",null,"You\u2019ll also ",Object(s.b)("strong",{parentName:"p"},"note the almost complete inability to abstract anything away here")," - if you want some common feature (e.g. a set of labels or something) across several services, you\u2019re going to need to either use an additional tool (",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://github.com/helm/helm"}),"helm")," might help), write it out explicitly in each YAML file, or do something with Kubectl to add it to your request (you can do this for ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/#setting-the-namespace-preference"}),"namespaces"),")."),Object(s.b)("p",null,"Pay attention to which particular K8s API you\u2019re referring to in the ",Object(s.b)("inlineCode",{parentName:"p"},"apiVersion"),", as this matters, and dictates which part of the K8s REST API your commands are directed at."),Object(s.b)("p",null,"I was originally going to discuss it in the next post, but decided that presenting broken k8s configs as correct is fairly cruel to anyone just trying to find a template for Kafka. Many systems (Kafka in this case) require an environment variable added the Kubernetes manifest along the lines of ",Object(s.b)("inlineCode",{parentName:"p"},"ADV_HOST=kafka-service.dev"),". This lets Kafka know which address it is listening on - Confluent explain it better than I can ",Object(s.b)("a",Object.assign({parentName:"p"},{href:"https://www.confluent.io/blog/kafka-listeners-explained"}),"here"),". If you hit connectivity issues with a system running in Docker containers, checking that the app in the container knows which address to advertise itself at is a good first step in resolving them."),Object(s.b)("h2",{id:"kubernetes-cluster-security"},"Kubernetes cluster security"),Object(s.b)("p",null,"We should first take steps to make sure our new cluster is secure. Sadly the only secure computer is one that is turned off, at the bottom of the ocean. This being incompatible with, well\u2026 basically every other requirement we have - we will have to make do with the clusterSecurity.yaml file in the repo, which ensures that;"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"No priveleged mode containers run."),Object(s.b)("li",{parentName:"ul"},"No containers can run as root."),Object(s.b)("li",{parentName:"ul"},"Containers can only access NFS volumes and persistent volume claims (for stateful set deployments). In other words, they shouldn\u2019t be touching your local storage.")),Object(s.b)("div",{className:i.a.floatright},Object(s.b)("pre",null,Object(s.b)("code",Object.assign({parentName:"pre"},{className:"language-yaml","data-language":"yaml","data-highlighted-line-numbers":"",dangerouslySetInnerHTML:{__html:'<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodSecurityPolicy\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> minikubesecurity\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n  <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rule</span><span class="token punctuation">:</span> MustRunAsNonRoot\n  <span class="token key atrule">seLinux</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny\n  <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny\n  <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny\n  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'nfs\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'persistentVolumeClaim\'</span>\n\n'}})))),Object(s.b)("p",null,"This is important because one of the major issues people hit when first using Docker in anger is around the use of the root user in the containers. This is bad practice and often a material security risk in Docker (one of the few), so we want to ensure that if we\u2019re doing it inadvertantly in dev, we get an error immediately rather than encountering mysterious issues at deployment (where we hope that the cluster admin has disabled the capability, as we have!)"),Object(s.b)("p",null,"Apply your security policies using ",Object(s.b)("inlineCode",{parentName:"p"},"kubectl create -f clusterSecurity.yaml"),"."),Object(s.b)("p",null,"The final point to be made on securing this cluster is to take note that ",Object(s.b)("strong",{parentName:"p"},"none of the services expose public IP addresses"),". To access (for example) the landoop UIs, we\u2019d run something like ",Object(s.b)("inlineCode",{parentName:"p"},"kubectl --namespace=dev port-forward service/kafka-service :3030"),", which forwards the port from our local machine over SSH. This is desirable, because we have not configured security on these GUIs, and by keeping them internal to the cluster we can piggyback off kubectl\u2019s authentication mechanisms and simplify our setup. Clearly, not appropriate for production usage."),Object(s.b)("h2",{id:"kubernetes-services"},"Kubernetes Services"),Object(s.b)("p",null,"We now have a functioning cluster, so let\u2019s get visibility of it using the Kubernetes Dashboard (we\u2019ll do better than this for monitoring, but we\u2019re still bootstrapping and need some visibility while we do so) using ",Object(s.b)("inlineCode",{parentName:"p"},"minikube dashboard"),". On a real cluster we\u2019d deploy pods and a service to handle this, but minikube makes things a bit simpler and lets us avoid creation of service accounts and worrying about authentication and so on."),Object(s.b)("p",null,"Without any further stuffing about, let\u2019s get it hooked up."),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"Create a dev user and namespace with ",Object(s.b)("inlineCode",{parentName:"li"},"kubectl apply -f dev-cluster.yaml")),Object(s.b)("li",{parentName:"ol"},"Run ",Object(s.b)("inlineCode",{parentName:"li"},"kubectl apply -f ${FILE}")," for each of the components we need (etcd, Fluentd, Kafka) for our dev platform and watch them appear on the dashboard.")),Object(s.b)("p",null,"Done. There are many improvements that could be made to this setup, but for writing an application it works as a minimum viable platform. If we were deploying this in the real world, we would have a vastly expanded range of things to think about;"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"How does our logging actually work? Fluentd needs somewhere to land its data, and Kafka isn\u2019t a good choice (for reasons that we\u2019ll cover later in the series). We could use Elasticsearch and Kibana (or something similar like Prometheus and Grafana) to visualise our logs from Fluentd."),Object(s.b)("li",{parentName:"ol"},"Authentication for all these front ends we\u2019re creating, and then Authorization to determine what permissions people should have."),Object(s.b)("li",{parentName:"ol"},"Where are we going for level two support? If we can\u2019t fix something ourselves who do we bring in and how much money do we have to pay them?"),Object(s.b)("li",{parentName:"ol"},"What network connectivity do we need? Load balancing? CDNs?"),Object(s.b)("li",{parentName:"ol"},"While we\u2019re talking about load, what about autoscaling?")),Object(s.b)("p",null,"6 - 100. Everything else."))}b.isMDXComponent=!0;var m=function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];return[{id:"but-my-code-is-already-unit-tested",level:3,title:"\u201cBut my code is already unit tested!\u201d",children:[]},{id:"whats-in-the-box-about-the-images-were-using",level:3,title:"What\u2019s in the box? About the images we\u2019re using.",children:[]},{id:"pre-requisites",level:2,title:"Pre-requisites",children:[]},{id:"getting-started---minikube",level:2,title:"Getting started - Minikube",children:[]},{id:"kubernetes-concepts-and-setup",level:2,title:"Kubernetes Concepts and setup",children:[]},{id:"running-an-application-on-kubernetes",level:2,title:"Running an application on Kubernetes",children:[{id:"kubernetes-pods",level:3,title:"Kubernetes pods",children:[]},{id:"controllers-services-and-everything-else",level:3,title:"Controllers, services\u2026 and everything else",children:[]},{id:"defining-kubernetes-entities",level:3,title:"Defining Kubernetes entities",children:[]}]},{id:"kubernetes-cluster-security",level:2,title:"Kubernetes cluster security",children:[]},{id:"kubernetes-services",level:2,title:"Kubernetes Services",children:[]}]},k={}},59:function(e,t,n){e.exports={image:"document_image__P0Wy7",figure:"document_figure__gp_zq",figureright:"document_figureright__JTrdm",figureleft:"document_figureleft__yBEAN",sidebarcontainer:"document_sidebarcontainer__PXI6m",sidebar:"document_sidebar__uvsTe"}},60:function(e,t,n){e.exports=n.p+"static/media/hacker.d472712f.gif"},61:function(e,t,n){e.exports=n.p+"static/media/another_hacker.1c323ee1.gif"}}]);
//# sourceMappingURL=5.7cb2b7b2.chunk.js.map
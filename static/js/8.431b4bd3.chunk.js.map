{"version":3,"sources":["routes/posts/2023-02-16-Making Go functions generic I/document.mdx","routes/posts/2023-02-16-Making Go functions generic I/document.module.css","routes/posts/2023-02-16-Making Go functions generic I/gears1.PNG"],"names":["readingTime","text","minutes","time","words","layoutProps","MDXLayout","MDXContent","_ref","components","props","Object","_home_user_Documents_projects_blog_client_react_blog_node_modules_babel_preset_react_app_node_modules_babel_runtime_helpers_esm_objectWithoutProperties__WEBPACK_IMPORTED_MODULE_0__","_mdx_js_react__WEBPACK_IMPORTED_MODULE_2__","assign","mdxType","id","className","styles","style","marginLeft","src","gears","alt","parentName","href","flexDirection","width","clear","isMDXComponent","tableOfContents","arguments","length","undefined","level","title","children","frontMatter","module","exports","image","figure","sidebarcontainer","floatright","sidebar","rainbow","rainbow-bg","__webpack_require__","p"],"mappings":"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","file":"static/js/8.431b4bd3.chunk.js","sourcesContent":["\nimport React from 'react'\nimport { mdx } from '@mdx-js/react'\nexport const readingTime = {\"text\":\"9 min read\",\"minutes\":8.65,\"time\":519000,\"words\":1730}\n/* @jsx mdx */\nimport styles from './document.module.css'\nimport gears from './gears1.PNG'\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  \n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n    <p>{`As we all know, Go recently introduced generics as part of their 1.19 release. This has caused me personally no end of sadness, since every time I’ve attempted to use them to solve problems (and believe me, we desperately need them to solve some big ones) I’ve burned half a week deciphering cryptic compiler errors before giving up.`}</p>\n    <p>{`This doesn’t generally lead to a productive sprint. So I’m here to discuss how to make this cursed syntax work.`}</p>\n    <h3 {...{\n      \"id\": \"what-is-a-kubernetes-operator\"\n    }}>{`What is a Kubernetes operator?`}</h3>\n    <div className={styles[\"sidebarcontainer\"]} style={{\n      marginLeft: \"0\"\n    }}>\n      <span>\n        <figure className={styles[\"figure\"]}>\n  <img src={gears} className={styles[\"image\"]} alt=\"A big set of neon gears and machinery.\" />\n  <figcaption>An actual Kubernete in the wild.</figcaption>\n        </figure>\n      </span>\n      <span className={styles[\"sidebar\"]}>\n        <h2 {...{\n          \"id\": \"background\"\n        }}>{`Background`}</h2>\n        <p>{`As you may know, Kubernetes is a kind of operating system for data centers. It allows for scheduling workloads across a fleet of (possibly ever changing) nodes such that they enjoy elasticity and resilience. As well as scheduling workloads, it offers a variety of ways to manage networking and storage concerns, so that workloads have the routing, firewalling, authn/z and storage dependencies they need to run.`}</p>\n        <p>{`Kubernetes operators are a way to hook into the Kubernetes infrastructure and build new pluggable functionality. They are particularly important for systems like Cassandra, where we often see complex operational procedures carried out. Running Cassandra is a full time job for many teams, and bootstrapping new nodes, replacing old ones, juggling token range movements, and securing network communications is complex.`}</p>\n        <p>{`One open source project I work on is `}<a parentName=\"p\" {...{\n            \"href\": \"https://github.com/k8ssandra/k8ssandra-operator\"\n          }}>{`k8ssandra-operator`}</a>{`, which aims to automate some of these concerns within Kubernetes clusters, and is where the insights in this blog post come from.`}</p>\n      </span>\n    </div>\n    <h3 {...{\n      \"id\": \"the-runtime-infrastructure\"\n    }}>{`The runtime infrastructure`}</h3>\n    <p>{`When building Kubernetes operators, we generally have a few pieces of tooling to make our lives bearable. We use `}<inlineCode parentName=\"p\">{`kubebuilder`}</inlineCode>{` to generate CRDs (custom resource definitions) which are JSON schemata that reside on the API server and provide validation for objects submitted to it. `}</p>\n    <p>{`Using `}<inlineCode parentName=\"p\">{`kubebuilder`}</inlineCode>{`, we write standard go structs, marked up with json tags like so:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`type GuestbookSpec struct {\n    Field1 string  \\`json:\"field1\"\\`\n    Field2 *string \\`json:\"field2,omitempty\"\\`\n}\n`}</code></pre>\n    <p>{`These json tagged structs are then used to generate some CRD that looks something like `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/k8ssandra/k8ssandra-operator/blob/main/config/crd/bases/k8ssandra.io_k8ssandraclusters.yaml\"\n      }}>{`this`}</a>{` horror. You can see why you would never want to hand write it.`}</p>\n    <p>{`Kubebuilder leverages `}<inlineCode parentName=\"p\">{`controller-gen`}</inlineCode>{` to generate some neccessary methods for each of our declared types, similar to the following:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`func (*GuestbookSpec in) DeepCopy(*Guestbook out) *Guestbook {}\nfunc (*GuestbookSpec in) DeepCopyInto()  {}\n`}</code></pre>\n    <p>{`While each operator undertakes a unique set of steps to reconcile the resources under its control into a desired state, it is also the case that most reconciliation logic is broadly homogenous, following some steps similar to the following:`}</p>\n    <ol>\n      <li parentName=\"ol\">{`Look for a resource with the same name on the cluster.`}</li>\n      <li parentName=\"ol\">{`Compare the current and desired states.`}</li>\n      <li parentName=\"ol\">{`If they do not match, perform an update.`}</li>\n    </ol>\n    <h2 {...{\n      \"id\": \"the-problem\"\n    }}>{`The problem`}</h2>\n    <p>{`You’d think that (given the reconciliation logic is the same across all Kubernetes objects) a single function could encapsulate it. But problematically, every resource has its own type in Go. As we know, historically in Golang it has not been easy to build generic functions that take a range of types, the Go idiom (according to the Go “gurus” I know) is to manually copy every piece of code for every type. Apparently this has absolutely `}<em parentName=\"p\">{`nothing`}</em>{` to do with the LOC metrics they produce - and I totally believe this.`}</p>\n    <p>{`As a result, you end up with a range of functions that look like this:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`func ReconcileConfigMap(desiredObject corev1.ConfigMap)\nfunc ReconcilePod(desiredObject corev1.Pod)\n`}</code></pre>\n    <p>{`Unfortunately for my team, this munchkinry led to duplication of the same logic approximately 15 times to date in our little corner of the reconciliation process, and the logic that was implemented in k8ssandra-operator began to diverge amongst the various authors.`}</p>\n    <p>{`This state of affairs effectively broke encapsulation entirely, and no one was quite sure how to fix it (or whether it was fixable without some codegen horseshit - which would have again bumped our LOC metrics but also just sucks).`}</p>\n    <h2 {...{\n      \"id\": \"preliminary-work\"\n    }}>{`Preliminary work`}</h2>\n    <p>{`Let’s kick off by scaffolding out a Kubernetes operator using kubebuilder, we’ll use their Guestbook example with a few customisations to demonstrate this functionality.`}</p>\n    <p>{`Start by `}<a parentName=\"p\" {...{\n        \"href\": \"https://book.kubebuilder.io/quick-start.html#installation\"\n      }}>{`installing`}</a>{` kubebuilder, then run:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`mkdir -p ~/projects/guestbook\ncd ~/projects/guestbook\nkubebuilder init --domain github.com --repo github.com/miles-garnsey/golang-generics-demo\n`}</code></pre>\n    <p>{`(Make sure you replace the domain and repo arguments with something appropriate for some Git server system that you own).`}</p>\n    <p>{`Or you can just check out my `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/Miles-Garnsey/go-generics-blog/commit/262c1bb920ea9d6872083334c99007785c9f6fc2\"\n      }}>{`commit`}</a>{` and be lazy, I won’t know, I swear.`}</p>\n    <p>{`Now scaffold the k8s APIs you want:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`kubebuilder create api --group webapp --version v1 --kind Guestbook\n`}</code></pre>\n    <p>{`To make life easier, you’ll want to add a few kubernetes modules like so:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`go get k8s.io/apimachinery/pkg/apis/meta/v1\ngo get k8s.io/client-go/kubernetes/fake\ngo get k8s.io/api/core/v1\n`}</code></pre>\n    <p>{`Or again, just check out `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/Miles-Garnsey/go-generics-blog/commit/d276fdd82e835d5a01d667a6231a830978979ccb\"\n      }}>{`my commit`}</a>{`.`}</p>\n    <p>{`I won’t be going into depth on these matters as a part of this blog post, suffice to say that there is API stuff we’ll be working with.`}</p>\n    <div className={styles[\"sidebarcontainer\"]}>\n      <span className={styles[\"sidebar\"]}>\n        <h3 {...{\n          \"id\": \"youll-want-to-have-tests\"\n        }}>{`You’ll want to have tests…`}</h3>\n        <p>{`It is worth taking a second here to note that this is one of those cases where you really, `}<em parentName=\"p\">{`really`}</em>{`, want to have tests as you’re developing (i.e. do TDD). I came to several “solutions” in the course of exploring that couldn’t be called with any variety of arguments. `}</p>\n        <p>{`If it doesn’t pass tests, it isn’t ANY sort of solution. We’ll move onto creating one in a minute.`}</p>\n      </span>\n      <span styles={{\n        flexDirection: \"column\"\n      }}>\n        <h2 {...{\n          \"id\": \"starting-in-on-a-solution\"\n        }}>{`Starting in on a solution`}</h2>\n        <p>{`Given that all Kubernetes object representations in Go should share a similar set of functions, one would expect that they should all fulfill a particular set of interfaces and therefore be somewhat fungible with respect to the reconciliation process.`}</p>\n        <p>{`All that we need them to have in common are method calls such as `}<inlineCode parentName=\"p\">{`DeepCopy`}</inlineCode>{`, `}<inlineCode parentName=\"p\">{`DeepCopyInto`}</inlineCode>{`, and to fulfil the `}<inlineCode parentName=\"p\">{`client.Object`}</inlineCode>{` interface (from the Kubernetes client `}<inlineCode parentName=\"p\">{`client-go`}</inlineCode>{`) so that they can be used in calls such as `}<inlineCode parentName=\"p\">{`client.Get`}</inlineCode>{`, `}<inlineCode parentName=\"p\">{`client.Update`}</inlineCode>{` and the like.`}</p>\n      </span>\n    </div>\n    <div style={{\n      width: '100%',\n      clear: 'both'\n    }}>\n    </div>\n    <h2 {...{\n      \"id\": \"so-this-should-be-easy\"\n    }}>{`So this should be easy…`}</h2>\n    <p>{`Famous last words. We know it won’t be, or I wouldn’t be writing a blog.`}</p>\n    <p>{`In a rational world where language designers cast aside their sadism, and LOC metrics didn’t exist, we could write a function with the following signature and a few example calls which would do the job:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`// in reconciliation/object.go\nfunc ReconcileObject(ctx context.Context, client kClient.Client, desiredObject client.Object) error {\n    desiredObjectName := types.NamespacedName{\n        Name:      desiredObject.GetName(),\n        Namespace: desiredObject.GetNamespace(),\n    }\n    var currentObject client.Object\n\n    err := kClient.Get(ctx, desiredObjectName, currentObject)\n    if err != nil {\n        return err\n    }\n    desiredObject.DeepCopyInto(currentObject)\n}\n`}</code></pre>\n    <p>{`This function would run through the steps above before returning either an error or nil (for a successful result). We’d call it as below:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`result := ReconcileObject(ctx, client desiredCM)\n`}</code></pre>\n    <p>{`For a snapshot at this point (which will help with imports etc.) go `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/Miles-Garnsey/go-generics-blog/commit/c84728b515aa759502662e1d4ad24a1f6f9272d2\"\n      }}>{`here`}</a>{`.`}</p>\n    <p>{`But we don’t live in a perfect world. If we try to compile code with the above function signature, what we’ll find is that we get an error as follows:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`desiredObject.DeepCopyInto undefined (type client.Object has no field or method DeepCopyInto)\n`}</code></pre>\n    <p><em parentName=\"p\">{`(On more recent versions you seem to also get `}<inlineCode parentName=\"em\">{`client.Object is not a type`}</inlineCode>{`, which would have saved me a few hours!)`}</em></p>\n    <p>{`Fair enough, remember that `}<inlineCode parentName=\"p\">{`DeepCopyInto`}</inlineCode>{` is codegen’ed (hello LOC!) by our frameworks, so it isn’t actually part of `}<inlineCode parentName=\"p\">{`client.Object`}</inlineCode>{`. `}</p>\n    <p>{`Anyway, we all know how to define a composite interface to get us what we need here. We just need to embed `}<inlineCode parentName=\"p\">{`client.Object`}</inlineCode>{` in our own interface and off we go:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`type Reconcilable interface {\n    client.Object\n    DeepCopy() client.Object\n    DeepCopyInto(client.Object)\n}\n// New function signature:\nfunc ReconcileObject(ctx context.Context, kClient client.Client, desiredObject Reconcilable) error {}\n`}</code></pre>\n    <p>{`So there’s no problem here right? Everything appears to compile, so let’s move on to creating a test for this:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`package reconciliation\n\nimport (\n    \"context\"\n    \"testing\"\n\n    \"github.com/stretchr/testify/assert\"\n    corev1 \"k8s.io/api/core/v1\"\n    metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n    \"sigs.k8s.io/controller-runtime/pkg/client/fake\"\n)\n\nfunc ReconcileObject_Test(t *testing.T) {\n    desiredObject := corev1.ConfigMap{\n        ObjectMeta: metav1.ObjectMeta{\n            Name:      \"test-cm\",\n            Namespace: \"test-namespace\",\n        },\n    }\n    ctx := context.Background()\n    client := fake.NewClientBuilder().\n        Build()\n\n    err := ReconcileObject(ctx, client, desiredObject)\n    assert.NoError(t, err)\n}\n`}</code></pre>\n    <p>{`Another error:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`cannot use desiredObject (variable of type \"k8s.io/api/core/v1\".ConfigMap) as Reconcilable value in argument to ReconcileObject: \"k8s.io/api/core/v1\".ConfigMap does not implement Reconcilable (wrong type for method DeepCopy)\n        have DeepCopy() *\"k8s.io/api/core/v1\".ConfigMap\n        want DeepCopy() client.Object\n`}</code></pre>\n    <p>{`Check `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/Miles-Garnsey/go-generics-blog/commit/1a2de72fc9b5de0f1e81fb4079767dc1b5ecda57\"\n      }}>{`here`}</a>{` for where the code is up to if you’re lost.`}</p>\n    <h1 {...{\n      \"id\": \"what-happened\"\n    }}>{`What happened?`}</h1>\n    <p>{`We can’t necessarily use interfaces to solve this problem, even when we know that the types line up to the extent we need them to.`}</p>\n    <p>{`Go doesn’t do type inference on interface return types from methods in an interface. So implementors (i.e. `}<inlineCode parentName=\"p\">{`ConfigMap`}</inlineCode>{`) which return a concrete type (rather than the interface) will fail. This happens even though `}<inlineCode parentName=\"p\">{`ConfigMap`}</inlineCode>{` indeed fulfils `}<inlineCode parentName=\"p\">{`client.Object`}</inlineCode></p>\n    <p>{`The Go “idiom” historically is to duplicate functions for every type, even when they’re exactly the same. Consequently, Go engineers are among the most “productive” in terms of LOC output.`}</p>\n    <h1 {...{\n      \"id\": \"what-have-we-learned\"\n    }}>{`What have we learned?`}</h1>\n    <p>{`This problem basically comes down to one of the differences between Go and Java.`}</p>\n    <p>{`In Java (which sucks in it’s own special ways) oftentimes a committment on the part of an abstract member in an interface (which isn’t even a thing in Go) to return an interface is acceptable. To the extent that a given group of interfaces may collaborate amongst themselves without really needing to know much about their underlying concrete types this is all fine. Yes, this does lead to excessive abstraction and certain types of obfuscation on the part of engineers keen to preserve their job security, but it is a different type of obfuscation to what we get with Go, where we have to explicitly re-write every function for every type.`}</p>\n    <p>{`Go isn’t really object oriented (which might be a good thing most of the time). There aren’t really concepts like subtypes, supertypes or variance, and it is considered `}<a parentName=\"p\" {...{\n        \"href\": \"https://bryanftan.medium.com/accept-interfaces-return-structs-in-go-d4cab29a301b\"\n      }}>{`best practice`}</a>{` (at least in some quarters…) to always return a concrete (never an interface) type. So good luck trying to abstract logic across multiple types - it isn’t easy.`}</p>\n    <p>{`The next installment of this blog will fail a few more times to make this concept work with generics. (We’ll succeed eventually, but I had to go through the journey and now so do you.)`}</p>\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;\nexport const tableOfContents = (components={}) => [\n  {\n    id: \"what-is-a-kubernetes-operator\",\n    level: 3,\n    title: \"What is a Kubernetes operator?\",\n    children: [\n        \n      ]\n  },\n{\n    id: \"background\",\n    level: 2,\n    title: \"Background\",\n    children: [\n        {\n              id: \"the-runtime-infrastructure\",\n              level: 3,\n              title: \"The runtime infrastructure\",\n              children: [\n                      \n                    ]\n            }\n      ]\n  },\n{\n    id: \"the-problem\",\n    level: 2,\n    title: \"The problem\",\n    children: [\n        \n      ]\n  },\n{\n    id: \"preliminary-work\",\n    level: 2,\n    title: \"Preliminary work\",\n    children: [\n        {\n              id: \"youll-want-to-have-tests\",\n              level: 3,\n              title: \"You’ll want to have tests…\",\n              children: [\n                      \n                    ]\n            }\n      ]\n  },\n{\n    id: \"starting-in-on-a-solution\",\n    level: 2,\n    title: \"Starting in on a solution\",\n    children: [\n        \n      ]\n  },\n{\n    id: \"so-this-should-be-easy\",\n    level: 2,\n    title: \"So this should be easy…\",\n    children: [\n        \n      ]\n  }\n]\n\nexport const frontMatter = {}\n\n","// extracted by mini-css-extract-plugin\nmodule.exports = {\"image\":\"document_image__1chts\",\"figure\":\"document_figure__2UQv0\",\"sidebarcontainer\":\"document_sidebarcontainer__vLT14\",\"floatright\":\"document_floatright__1MN0P\",\"sidebar\":\"document_sidebar__GWdVn\",\"rainbow\":\"document_rainbow__vQl_r\",\"rainbow-bg\":\"document_rainbow-bg__3VYxN\"};","module.exports = __webpack_public_path__ + \"static/media/gears1.b98b3853.PNG\";"],"sourceRoot":""}